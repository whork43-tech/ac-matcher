{% extends "base.html" %}
{% block content %}
  <section class="section">
    <div class="section-head">
      <div>
        <div class="h2">案件 #{{ job.id }} · {{ job.service_type }}</div>
        <div class="small">{{ job.city }} {{ job.district }} · {{ job.units }} 台 · {{ job.created_at }}</div>
      </div>
      <div class="actions">
        {% if job.status == "open" %}
          {% if job.urgent %}
            <span class="badge red">急件</span>
          {% else %}
            <span class="badge green">一般</span>
          {% endif %}
          <span class="badge green">開放中</span>
        {% else %}
          <span class="badge amber">已成交/關閉</span>
        {% endif %}
        <a class="btn small" href="/jobs">回列表</a>
      </div>
    </div>

    <div class="section-body">
      <div class="grid">
        <div class="col-7">
          <div class="card">
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <span class="badge violet">{{ job.service_type }}</span>
              <span class="badge amber">{{ job.ac_type or "冷氣類型未填" }}</span>
              <span class="badge green">{{ job.units }} 台</span>
            </div>

            <div style="height:10px"></div>
            <div class="grid">
              <div class="col-6 card soft">
                <div class="h3">可約時間</div>
                <div class="p">{{ job.time_window or "未填" }}</div>
              </div>
              <div class="col-6 card soft">
                <div class="h3">位置備註</div>
                <div class="p">{{ job.address_note or "未填" }}</div>
              </div>
              <div class="col-12 card soft">
                <div class="h3">描述</div>
                <div class="p">{{ job.description or "未填" }}</div>
              </div>
              <div class="col-12 card soft">
                <div class="h3">樓層 / 電梯</div>
                <div class="p">{{ job.floor or "未填" }}</div>
              </div>
            </div>
          </div>

          {% if user and user.role == "owner" and job.owner_id == user.id %}
            <div style="height:14px"></div>
            <div class="card">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
                <div>
                  <div class="h2">收到的提案</div>
                  <div class="small">只有案主本人看得到（MVP）</div>
                </div>

                {% if job.status == "open" %}
                  <form method="post" action="/jobs/{{ job.id }}/close" style="margin:0;">
                    <button class="btn primary" type="submit">成交並關閉案件</button>
                  </form>
                {% else %}
                  <span class="badge amber">此案件已關閉</span>
                {% endif %}
              </div>

              <div style="height:10px"></div>

              {% if proposals %}
                {% for p in proposals %}
                  <div class="card soft" style="margin-bottom:10px;">
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
                      <div style="font-weight:900;font-size:18px;">NT$ {{ p.price }}</div>
                      <div class="small">{{ p.created_at }}</div>
                    </div>
                    <div style="height:10px"></div>

                    {# === 師傅資訊 + 徽章 + 查看師傅檔案（C 方案 MVP）=== #}
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
                      <div>
                        <div class="small">師傅</div>
                        <div style="font-weight:900;">{{ (p.provider.name if p.provider else ("師傅 #" ~ p.provider_id)) | e }}</div>

                        <div style="height:6px"></div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;">
                          {% set badges = provider_badges.get(p.provider_id, []) %}
                          {% for b in badges %}
                            {% if b.ok %}
                              <span class="badge green">✅ {{ b.label }}</span>
                            {% endif %}
                          {% endfor %}
                          {% if badges|selectattr('ok')|list|length == 0 %}
                            <span class="badge amber">尚未驗證</span>
                          {% endif %}
                        </div>
                      </div>

                      <a class="btn small" href="/providers/{{ p.provider_id }}">查看師傅檔案</a>
                    </div>

                    <div style="height:12px"></div>
                    <div style="height:8px"></div>
                    <div class="grid">
                      <div class="col-6">
                        <div class="small">可到場</div>
                        <div style="font-weight:800;">{{ p.available_time or "未填" }}</div>
                      </div>
                      <div class="col-6">
                        <div class="small">保固</div>
                        <div style="font-weight:800;">{{ p.warranty or "未填" }}</div>
                      </div>
                      <div class="col-12">
                        <div class="small">備註</div>
                        <div class="p">{{ p.note or "未填" }}</div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="card soft">
                  <div class="h3">目前尚未收到提案</div>
                  <p class="p">師傅登入後才能對此案件報價提案。</p>
                </div>
              {% endif %}
            </div>
          {% endif %}
        </div>

        <div class="col-5">
          {% if user and user.role == "provider" %}
            {% if job.status != "open" %}
              <div class="card">
                <div class="badge amber">案件已關閉</div>
                <div style="height:8px"></div>
                <div class="h2">這筆案件已成交</div>
                <p class="p">目前不開放再提案。</p>
                <div style="height:10px"></div>
                <a class="btn" href="/jobs">回案件列表</a>
              </div>
            {% else %}
              <div class="card">
                <div class="badge green">師傅提案</div>
                <div style="height:8px"></div>
                <div class="h2">我要報價</div>
                <div class="small">填入價格與可到場時間，案主才看得到</div>
                <div style="height:10px"></div>

                <form class="form" method="post" action="/jobs/{{ job.id }}/propose">
                  <div class="field">
                    <div class="label">報價（整單）</div>
                    <input class="input" name="price" type="number" min="0" required placeholder="例：2500" />
                  </div>

                  <div class="field">
                    <div class="label">可到場時間（選填）</div>
                    <input class="input" name="available_time" placeholder="例：今天 18:00 後 / 週六下午" />
                  </div>

                  <div class="field">
                    <div class="label">保固（選填）</div>
                    <input class="input" name="warranty" placeholder="例：完工保固 30 天" />
                  </div>

                  <div class="field">
                    <div class="label">備註（選填）</div>
                    <textarea class="textarea" name="note" placeholder="例：含基本清潔、到場後若需補冷媒另報"></textarea>
                  </div>

                  <div class="actions">
                    <button class="btn green" type="submit">送出提案</button>
                    <a class="btn" href="/dashboard">回面板</a>
                  </div>
                </form>
              </div>
            {% endif %}
          {% else %}
            <div class="card">
              <div class="h2">想接案？</div>
              <p class="p">登入師傅帳號即可對案件提案報價。</p>
              <div style="height:10px"></div>
              <div class="actions">
                <a class="btn green" href="/login">師傅登入</a>
                <a class="btn" href="/register">註冊師傅</a>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </section>
{% endblock %}
